(import std)
(import net)

(defun main [Unit]
  (let ((host "gemini.circumlunar.space")
        (port (cast 1965))
        (h (unwrap! (tcp/connect-timeout host port (cast 2000))))
        (h (unwrap! (tls/connect-without-validation host h)))
        (query (apps str-append "gemini://" host "/\r\n"))
        (_ (handle/write-str query h))
        ([h s] (unwrap! (handle/read-to-str h)))
        ([(Str header) body] (unwrap! (string/split-first-line s)))

        ([code meta] (map-two (apps <o unwrap! parse-nat Str)
                              (<o Str (partial-2 array/slice-from 1))
                              (unwrap! (array/split (cast 2) header))))
        (_ (display (str-append "Code: " (show-nat code))))
        (_ (display (str-append "Meta: " meta)))
        (_ (display "Body"))
        (_ (display "================================================="))
        (_ (display body))
        (_ (display "==================================================")))
    Unit))
